<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Board</title>

  <!-- Vue 3 (CDN) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* 토스트의 pre-wrap 같은 “딱 필요한” 것만 최소 유지 */
    .prewrap { white-space: pre-wrap; }
  </style>
</head>

<body class="min-h-screen bg-[radial-gradient(1200px_800px_at_20%_0%,#111a2b_0%,#0b0c10_55%)] text-slate-100">
  <div id="app">
    <!-- Header -->
    <header class="sticky top-0 z-10 border-b border-slate-800/70 bg-[#0b0c10]/70 backdrop-blur">
      <div class="mx-auto w-[min(1180px,92vw)] py-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <span class="h-2.5 w-2.5 rounded-full bg-sky-400 shadow-[0_0_0_6px_rgba(106,169,255,.12)]"></span>
            <h1 class="text-sm font-semibold tracking-wide">Board</h1>

            <span class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-white/5 px-3 py-1 text-xs text-slate-300">
              <span class="text-slate-400">API</span>
              <span class="break-all text-slate-300">{{ apiBaseLabel }}</span>
            </span>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-white/5 px-3 py-1 text-xs text-slate-300">
              <span class="text-slate-400">세션</span>
              <span v-if="me.logged_in">로그인됨 (user_id={{ me.user_id }})</span>
              <span v-else>비로그인</span>
            </span>

            <button
              class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm text-slate-200 hover:border-sky-400/50"
              @click="refreshMe"
            >
              상태 새로고침
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto w-[min(1180px,92vw)] py-4">
      <div class="grid gap-4 lg:grid-cols-[420px_1fr]">
        <!-- LEFT -->
        <section class="rounded-2xl border border-slate-800 bg-gradient-to-b from-[#111319] to-[#0f1116] p-4 shadow-[0_10px_30px_rgba(0,0,0,.35)]">
          <h2 class="mb-2 text-sm font-semibold">인증</h2>

          <div class="grid gap-3 sm:grid-cols-2">
            <!-- Signup -->
            <div class="rounded-2xl border border-slate-800 bg-white/5 p-3">
              <h3 class="mb-2 text-xs font-semibold text-slate-300">회원가입</h3>
              <div class="grid gap-2">
                <label class="grid gap-1 text-xs text-slate-400">
                  아이디
                  <input
                    v-model.trim="signupForm.username"
                    placeholder="username"
                    class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  />
                </label>

                <label class="grid gap-1 text-xs text-slate-400">
                  비밀번호
                  <input
                    v-model.trim="signupForm.password"
                    type="password"
                    placeholder="password"
                    class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  />
                </label>

                <label class="grid gap-1 text-xs text-slate-400">
                  닉네임
                  <input
                    v-model.trim="signupForm.nickname"
                    placeholder="nickname"
                    class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  />
                </label>

                <button
                  class="rounded-xl border border-slate-800 bg-sky-400/15 px-3 py-2 text-sm hover:border-sky-400/50"
                  @click="signup"
                >
                  회원가입
                </button>
              </div>
            </div>

            <!-- Login -->
            <div class="rounded-2xl border border-slate-800 bg-white/5 p-3">
              <h3 class="mb-2 text-xs font-semibold text-slate-300">로그인</h3>
              <div class="grid gap-2">
                <label class="grid gap-1 text-xs text-slate-400">
                  아이디
                  <input
                    v-model.trim="loginForm.username"
                    placeholder="username"
                    class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  />
                </label>

                <label class="grid gap-1 text-xs text-slate-400">
                  비밀번호
                  <input
                    v-model.trim="loginForm.password"
                    type="password"
                    placeholder="password"
                    class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  />
                </label>

                <div class="flex flex-wrap items-center gap-2">
                  <button
                    class="rounded-xl border border-slate-800 bg-sky-400/15 px-3 py-2 text-sm hover:border-sky-400/50"
                    @click="login"
                  >
                    로그인
                  </button>
                  <button
                    class="rounded-xl border border-rose-400/35 bg-rose-400/10 px-3 py-2 text-sm hover:border-rose-400/70"
                    @click="logout"
                  >
                    로그아웃
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="my-4 h-px bg-slate-800"></div>

          <h2 class="mb-2 text-sm font-semibold">내 프로필</h2>
          <div class="flex flex-wrap items-center gap-2">
            <button
              class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
              @click="loadMyProfile"
            >
              조회
            </button>
            <button
              class="rounded-xl border border-slate-800 bg-sky-400/15 px-3 py-2 text-sm hover:border-sky-400/50"
              @click="saveMyProfile"
            >
              저장(UPSERT)
            </button>
          </div>

          <div class="mt-3 grid gap-2">
            <label class="grid gap-1 text-xs text-slate-400">
              bio
              <textarea
                rows="3"
                v-model="profileForm.bio"
                placeholder="자기소개"
                class="w-full resize-y rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
              ></textarea>
            </label>

            <label class="grid gap-1 text-xs text-slate-400">
              phone
              <input
                v-model.trim="profileForm.phone"
                placeholder="010-1234-5678"
                class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
              />
            </label>

            <label class="grid gap-1 text-xs text-slate-400">
              birth_date (YYYY-MM-DD)
              <input
                v-model.trim="profileForm.birth_date"
                placeholder="2000-01-02"
                class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
              />
            </label>

            <label class="grid gap-1 text-xs text-slate-400">
              profile_image_url
              <input
                v-model.trim="profileForm.profile_image_url"
                placeholder="https://..."
                class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
              />
            </label>
          </div>

          <div class="my-4 h-px bg-slate-800"></div>

          <h2 class="mb-2 text-sm font-semibold">최근 로그</h2>
          <div class="rounded-2xl border border-slate-800 bg-white/5 p-3">
            <div class="prewrap break-words text-xs text-slate-300">{{ lastLog }}</div>
          </div>
        </section>

        <!-- RIGHT -->
        <section class="rounded-2xl border border-slate-800 bg-gradient-to-b from-[#111319] to-[#0f1116] p-4 shadow-[0_10px_30px_rgba(0,0,0,.35)]">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h2 class="text-sm font-semibold">게시글</h2>
            <div class="flex flex-wrap items-center gap-2">
              <button
                class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
                @click="loadPosts(true)"
              >
                목록 새로고침
              </button>
              <button
                class="rounded-xl border border-slate-800 bg-sky-400/15 px-3 py-2 text-sm hover:border-sky-400/50"
                @click="openNewPost"
              >
                새 글
              </button>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap items-center gap-2">
            <select
              v-model="postsQuery.type"
              class="w-[140px] rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm text-slate-100 outline-none focus:border-sky-400/60"
            >
              <option value="both">제목+내용</option>
              <option value="title">제목</option>
              <option value="content">내용</option>
            </select>

            <input
              v-model.trim="postsQuery.keyword"
              placeholder="검색어"
              class="min-w-[220px] flex-1 rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
            />

            <button
              class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
              @click="search"
            >
              검색
            </button>

            <div class="flex-1"></div>

            <label class="flex items-center gap-2 text-xs text-slate-400">
              pageSize
              <select
                v-model.number="postsQuery.pageSize"
                class="w-[110px] rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm text-slate-100 outline-none focus:border-sky-400/60"
              >
                <option :value="5">5</option>
                <option :value="20">20</option>
                <option :value="30">30</option>
                <option :value="50">50</option>
              </select>
            </label>
          </div>

          <div class="mt-3 grid gap-4 lg:grid-cols-[360px_1fr]">
            <!-- list -->
            <div>
              <div class="text-xs text-slate-400">total={{ posts.total }}, items={{ posts.items.length }}</div>

              <ul class="mt-2 grid gap-2">
                <li
                  class="rounded-2xl border border-slate-800 bg-white/5 p-3 hover:border-sky-400/40"
                  v-for="p in posts.items"
                  :key="p.id"
                >
                  <div class="flex items-start justify-between gap-2">
                    <button
                      class="text-left text-sm font-medium leading-snug text-sky-300 hover:text-sky-200"
                      @click="openPost(p.id)"
                    >
                      #{{ p.id }} {{ p.title }}
                    </button>

                    <span class="inline-flex items-center gap-2 rounded-full border border-slate-800 bg-white/5 px-2.5 py-1 text-xs text-slate-300">
                      v:{{ p.view_count }} c:{{ p.comments_cnt }}
                    </span>
                  </div>

                  <div class="mt-2 flex flex-wrap gap-3 text-xs text-slate-400">
                    <span>user_id={{ p.user_id }}</span>
                    <span class="break-all">{{ p.created_at }}</span>
                  </div>
                </li>
              </ul>

              <div class="mt-3 flex items-center justify-between gap-2">
                <button
                  class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
                  @click="prevPage"
                >
                  이전
                </button>

                <div class="flex items-center gap-2">
                  <span class="text-xs text-slate-400">page</span>
                  <input
                    type="number"
                    min="1"
                    v-model.number="postsQuery.page"
                    @change="loadPosts(false)"
                    class="w-[84px] rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-center text-sm outline-none focus:border-sky-400/60"
                  />
                  <span class="text-xs text-slate-400">/ {{ totalPages }}</span>
                </div>

                <button
                  class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
                  @click="nextPage"
                >
                  다음
                </button>
              </div>
            </div>

            <!-- detail -->
            <div class="rounded-2xl border border-slate-800 bg-white/5 p-3">
              <h2 class="text-sm font-semibold">상세</h2>

              <div v-if="!selectedPost" class="mt-2 text-sm text-slate-400">
                왼쪽에서 게시글을 선택하세요.
              </div>

              <div v-else class="mt-2 grid gap-2 text-sm">
                <div><span class="font-semibold text-slate-200">id</span>: {{ selectedPost.id }}</div>
                <div><span class="font-semibold text-slate-200">user_id</span>: {{ selectedPost.user_id }}</div>
                <div><span class="font-semibold text-slate-200">title</span>: {{ selectedPost.title }}</div>
                <div>
                  <span class="font-semibold text-slate-200">content</span>:
                  <div class="mt-1 break-words text-xs text-slate-300">{{ selectedPost.content }}</div>
                </div>
                <div><span class="font-semibold text-slate-200">view_count</span>: {{ selectedPost.view_count }}</div>
                <div><span class="font-semibold text-slate-200">comments_cnt</span>: {{ selectedPost.comments_cnt }}</div>
                <div><span class="font-semibold text-slate-200">created_at</span>: <span class="break-all text-xs text-slate-300">{{ selectedPost.created_at }}</span></div>
                <div><span class="font-semibold text-slate-200">viewer_key</span>: <span class="break-all text-xs text-slate-300">{{ selectedPost.viewer_key }}</span></div>
              </div>

              <div class="my-4 h-px bg-slate-800"></div>

              <h2 class="text-sm font-semibold">글 작성/수정</h2>

              <div class="mt-2 grid gap-2">
                <label class="grid gap-1 text-xs text-slate-400">
                  title (최대 45)
                  <input
                    maxlength="45"
                    v-model.trim="postForm.title"
                    placeholder="제목"
                    class="w-full rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  />
                </label>

                <label class="grid gap-1 text-xs text-slate-400">
                  content
                  <textarea
                    rows="5"
                    v-model="postForm.content"
                    placeholder="내용"
                    class="w-full resize-y rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  ></textarea>
                </label>

                <div class="flex flex-wrap items-center gap-2">
                  <button
                    class="rounded-xl border border-slate-800 bg-sky-400/15 px-3 py-2 text-sm hover:border-sky-400/50"
                    @click="savePost"
                  >
                    저장
                  </button>
                  <button
                    class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
                    @click="cancelPostEdit"
                  >
                    취소
                  </button>
                  <button
                    class="rounded-xl border border-rose-400/35 bg-rose-400/10 px-3 py-2 text-sm hover:border-rose-400/70 disabled:cursor-not-allowed disabled:opacity-50"
                    @click="deletePost"
                    :disabled="!postForm.id"
                  >
                    삭제
                  </button>
                </div>

                <div v-if="postForm.id" class="text-xs text-slate-400">
                  수정 모드: post_id={{ postForm.id }}
                </div>
              </div>

              <div class="my-4 h-px bg-slate-800"></div>

              <h2 class="text-sm font-semibold">댓글</h2>

              <div class="mt-2 grid gap-2">
                <label class="grid gap-1 text-xs text-slate-400">
                  comment (최대 255)
                  <textarea
                    rows="3"
                    v-model="commentForm.comment"
                    placeholder="댓글"
                    class="w-full resize-y rounded-xl border border-slate-800 bg-[#0b0d12] px-3 py-2 text-sm outline-none focus:border-sky-400/60"
                  ></textarea>
                </label>

                <div class="flex flex-wrap items-center gap-2">
                  <button
                    class="rounded-xl border border-slate-800 bg-sky-400/15 px-3 py-2 text-sm hover:border-sky-400/50 disabled:cursor-not-allowed disabled:opacity-50"
                    @click="addComment"
                    :disabled="!selectedPost"
                  >
                    작성
                  </button>

                  <button
                    class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50 disabled:cursor-not-allowed disabled:opacity-50"
                    @click="updateComment"
                    :disabled="!commentForm.id"
                  >
                    수정
                  </button>

                  <button
                    class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
                    @click="cancelCommentEdit"
                  >
                    취소
                  </button>
                </div>

                <div v-if="commentForm.id" class="text-xs text-slate-400">
                  수정 모드: comment_id={{ commentForm.id }}
                </div>
              </div>

              <ul class="mt-3 grid gap-2">
                <li
                  class="rounded-2xl border border-slate-800 bg-white/5 p-3"
                  v-for="c in comments"
                  :key="c.id"
                >
                  <div class="flex items-start justify-between gap-2">
                    <div class="text-xs text-slate-400">#{{ c.id }} (user_id={{ c.user_id }})</div>
                    <div class="break-all text-xs text-slate-400">{{ c.created_at }}</div>
                  </div>

                  <div class="mt-2 break-words text-xs text-slate-300">{{ c.comment }}</div>

                  <div class="mt-3 flex flex-wrap items-center gap-2">
                    <button
                      class="rounded-xl border border-slate-800 bg-transparent px-3 py-2 text-sm hover:border-sky-400/50"
                      @click="editComment(c)"
                    >
                      수정
                    </button>
                    <button
                      class="rounded-xl border border-rose-400/35 bg-rose-400/10 px-3 py-2 text-sm hover:border-rose-400/70"
                      @click="removeComment(c.id)"
                    >
                      삭제
                    </button>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </section>
      </div>

      <!-- Toast -->
      <div
        v-if="toast.show"
        class="fixed bottom-4 right-4 w-[min(460px,92vw)] rounded-2xl border border-slate-800 bg-[#111319]/90 p-3 shadow-[0_10px_30px_rgba(0,0,0,.35)]"
      >
        <button
          class="float-right cursor-pointer border-0 bg-transparent text-slate-400"
          @click="toast.show=false"
        >
          ✕
        </button>
        <div class="text-sm">{{ toast.title }}</div>
        <div class="mt-1 prewrap text-xs text-slate-400">{{ toast.body }}</div>
      </div>
    </main>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          apiBase: "http://www.localhost",
          apiPrefix: "/api",

          me: { logged_in: false, user_id: null },

          signupForm: { username: "", password: "", nickname: "" },
          loginForm: { username: "", password: "" },

          profileForm: { bio: "", phone: "", birth_date: "", profile_image_url: "" },

          postsQuery: { page: 1, pageSize: 5, type: "both", keyword: "" },
          posts: { total: 0, items: [] },

          selectedPost: null,
          postForm: { id: null, title: "", content: "" },

          comments: [],
          commentForm: { id: null, comment: "" },

          lastLog: "",
          toast: { show: false, title: "", body: "" },
        };
      },

      computed: {
        totalPages() {
          const t = this.posts.total || 0;
          const ps = this.postsQuery.pageSize || 20;
          return Math.max(1, Math.ceil(t / ps));
        },
        apiBaseLabel() {
          return (this.apiBase || "(same-origin)") + (this.apiPrefix || "");
        }
      },

      methods: {
        notify(title, body) {
          this.toast = { show: true, title, body: body ?? "" };
          setTimeout(() => { this.toast.show = false; }, 2500);
        },

        async request(path, options = {}) {
          const url = (this.apiBase || "") + (this.apiPrefix || "") + path;
          const opts = {
            method: options.method || "GET",
            headers: {
              "Content-Type": "application/json",
              ...(options.headers || {}),
            },
            credentials: "include",
            ...options,
          };
          if (opts.body && typeof opts.body !== "string") {
            opts.body = JSON.stringify(opts.body);
          }

          const res = await fetch(url, opts);
          const text = await res.text();
          let json = null;

          try { json = text ? JSON.parse(text) : null; }
          catch { json = { ok: false, message: "JSON 파싱 실패", raw: text }; }

          if (!res.ok) {
            return { ok: false, message: `HTTP ${res.status}`, data: json };
          }
          return json;
        },

        log(label, payload) {
          const line = typeof payload === "string"
            ? payload
            : (() => { try { return JSON.stringify(payload, null, 2); } catch { return String(payload); } })();
          this.lastLog = `[${label}]\n${line}`;
        },

        // -------------------------
        // Auth
        // -------------------------
        async refreshMe() {
          const r = await this.request("/me");
          if (r?.ok) {
            this.me = r.data;
          } else {
            this.log("/me fail", r);
            this.notify("세션 상태 확인 실패", r?.message || "");
          }
        },

        async signup() {
          const body = {
            username: this.signupForm.username?.trim(),
            password: this.signupForm.password?.trim(),
            nickname: this.signupForm.nickname?.trim(),
          };
          const r = await this.request("/signup", { method: "POST", body });
          if (r?.ok) {
            this.log("signup ok", r.data);
            this.notify("회원가입 완료", `user_id=${r.data.user_id}`);
          } else {
            this.log("signup fail", r?.message || "");
            this.notify("회원가입 실패", r?.message || "");
          }
        },

        async login() {
          const body = {
            username: this.loginForm.username?.trim(),
            password: this.loginForm.password?.trim(),
          };
          const r = await this.request("/login", { method: "POST", body });
          if (r?.ok) {
            this.log("login ok", r.data);
            this.notify("로그인 완료", `user_id=${r.data.user_id}`);
            await this.refreshMe();
          } else {
            this.log("login fail", r?.message || "");
            this.notify("로그인 실패", r?.message || "");
          }
        },

        async logout() {
          const r = await this.request("/logout", { method: "POST", body: {} });
          if (r?.ok) {
            this.log("logout ok", "");
            this.notify("로그아웃", "");
            await this.refreshMe();
          } else {
            this.log("logout fail", r?.message || "");
            this.notify("로그아웃 실패", r?.message || "");
          }
        },

        // -------------------------
        // Profile
        // -------------------------
        async loadMyProfile() {
          const r = await this.request("/me/profile");
          if (r?.ok) {
            const d = r.data || {};
            this.profileForm.bio = d.bio ?? "";
            this.profileForm.phone = d.phone ?? "";
            this.profileForm.birth_date = d.birth_date ?? "";
            this.profileForm.profile_image_url = d.profile_image_url ?? "";
            this.log("myProfile ok", d);
            this.notify("프로필 조회", "");
          } else {
            this.log("myProfile fail", r?.message || "");
            this.notify("프로필 조회 실패", r?.message || "");
          }
        },

        async saveMyProfile() {
          const body = {
            bio: this.profileForm.bio?.trim() || null,
            phone: this.profileForm.phone?.trim() || null,
            birth_date: this.profileForm.birth_date?.trim() || null,
            profile_image_url: this.profileForm.profile_image_url?.trim() || null,
          };
          const r = await this.request("/me/profile", { method: "PUT", body });
          if (r?.ok) {
            this.log("profile upsert ok", r.data);
            this.notify("프로필 저장", "");
            await this.loadMyProfile();
          } else {
            this.log("profile upsert fail", r?.message || "");
            this.notify("프로필 저장 실패", r?.message || "");
          }
        },

        // -------------------------
        // Posts
        // -------------------------
        buildPostsQuery() {
          const q = new URLSearchParams();
          q.set("page", String(this.postsQuery.page || 1));
          q.set("pageSize", String(this.postsQuery.pageSize || 20));

          const keyword = (this.postsQuery.keyword || "").trim();
          if (keyword) {
            q.set("type", this.postsQuery.type || "both");
            q.set("keyword", keyword);
          }
          return q.toString();
        },

        async loadPosts(resetPage) {
          if (resetPage) this.postsQuery.page = 1;
          const qs = this.buildPostsQuery();
          const r = await this.request(`/posts?${qs}`);
          if (r?.ok) {
            this.posts.total = r.data.total || 0;
            this.posts.items = r.data.items || [];
          } else {
            this.log("posts fail", r?.message || "");
            this.notify("목록 조회 실패", r?.message || "");
          }
        },

        async openPost(id) {
          const r = await this.request(`/posts/${id}`);
          if (r?.ok) {
            this.selectedPost = r.data;
            this.postForm.id = r.data.id;
            this.postForm.title = r.data.title || "";
            this.postForm.content = r.data.content || "";
            await this.loadComments();
          } else {
            this.log("post detail fail", r?.message || "");
            this.notify("상세 조회 실패", r?.message || "");
          }
        },

        openNewPost() {
          this.selectedPost = null;
          this.postForm = { id: null, title: "", content: "" };
          this.comments = [];
          this.commentForm = { id: null, comment: "" };
          this.notify("새 글", "작성 모드로 전환");
        },

        async savePost() {
          const title = (this.postForm.title || "").trim();
          const content = (this.postForm.content || "").trim();
          if (!title || !content) {
            this.notify("입력값 오류", "title/content는 필수입니다");
            return;
          }

          if (!this.postForm.id) {
            const r = await this.request("/posts", { method: "POST", body: { title, content } });
            if (r?.ok) {
              this.log("create post ok", r.data);
              this.notify("글 작성 완료", `post_id=${r.data.post_id}`);
              await this.loadPosts(false);
              await this.openPost(r.data.post_id);
            } else {
              this.log("create post fail", r?.message || "");
              this.notify("글 작성 실패", r?.message || "");
            }
          } else {
            const id = this.postForm.id;
            const r = await this.request(`/posts/${id}`, { method: "PUT", body: { title, content } });
            if (r?.ok) {
              this.log("update post ok", r.data);
              this.notify("글 수정 완료", "");
              await this.loadPosts(false);
              await this.openPost(id);
            } else {
              this.log("update post fail", r?.message || "");
              this.notify("글 수정 실패", r?.message || "");
            }
          }
        },

        async deletePost() {
          const id = this.postForm.id;
          if (!id) {
            this.notify("삭제 불가", "삭제할 글이 선택되지 않았습니다");
            return;
          }
          const r = await this.request(`/posts/${id}`, { method: "DELETE" });
          if (r?.ok) {
            this.log("delete post ok", r.data);
            this.notify("글 삭제", "");
            this.openNewPost();
            await this.loadPosts(false);
          } else {
            this.log("delete post fail", r?.message || "");
            this.notify("글 삭제 실패", r?.message || "");
          }
        },

        cancelPostEdit() {
          if (this.selectedPost?.id) {
            this.postForm.id = this.selectedPost.id;
            this.postForm.title = this.selectedPost.title || "";
            this.postForm.content = this.selectedPost.content || "";
          } else {
            this.openNewPost();
          }
        },

        search() {
          this.postsQuery.page = 1;
          this.loadPosts(false);
        },
        prevPage() {
          this.postsQuery.page = Math.max(1, (this.postsQuery.page || 1) - 1);
          this.loadPosts(false);
        },
        nextPage() {
          this.postsQuery.page = (this.postsQuery.page || 1) + 1;
          this.loadPosts(false);
        },

        // -------------------------
        // Comments
        // -------------------------
        async loadComments() {
          if (!this.selectedPost?.id) return;
          const r = await this.request(`/posts/${this.selectedPost.id}/comments`);
          if (r?.ok) {
            this.comments = (r.data.items || []);
          } else {
            this.comments = [];
            this.log("comments fail", r?.message || "");
          }
        },

        async addComment() {
          if (!this.selectedPost?.id) {
            this.notify("댓글 작성", "게시글을 먼저 선택하세요");
            return;
          }
          const comment = (this.commentForm.comment || "").trim();
          if (!comment) {
            this.notify("입력값 오류", "comment는 필수입니다");
            return;
          }
          const r = await this.request(`/posts/${this.selectedPost.id}/comments`, {
            method: "POST",
            body: { comment }
          });
          if (r?.ok) {
            this.notify("댓글 작성 완료", `comment_id=${r.data.comment_id}`);
            this.commentForm = { id: null, comment: "" };
            await this.openPost(this.selectedPost.id);
          } else {
            this.notify("댓글 작성 실패", r?.message || "");
          }
        },

        editComment(c) {
          this.commentForm.id = c.id;
          this.commentForm.comment = c.comment || "";
        },

        async updateComment() {
          const id = this.commentForm.id;
          if (!id) {
            this.notify("수정 불가", "수정할 댓글을 선택하세요");
            return;
          }
          const comment = (this.commentForm.comment || "").trim();
          if (!comment) {
            this.notify("입력값 오류", "comment는 필수입니다");
            return;
          }
          const r = await this.request(`/comments/${id}`, {
            method: "PUT",
            body: { comment }
          });
          if (r?.ok) {
            this.notify("댓글 수정 완료", "");
            this.commentForm = { id: null, comment: "" };
            await this.loadComments();
          } else {
            this.notify("댓글 수정 실패", r?.message || "");
          }
        },

        async removeComment(id) {
          const r = await this.request(`/comments/${id}`, { method: "DELETE" });
          if (r?.ok) {
            this.notify("댓글 삭제", "");
            this.commentForm = { id: null, comment: "" };
            if (this.selectedPost?.id) await this.openPost(this.selectedPost.id);
          } else {
            this.notify("댓글 삭제 실패", r?.message || "");
          }
        },

        cancelCommentEdit() {
          this.commentForm = { id: null, comment: "" };
        },
      },

      async mounted() {
        await this.refreshMe();
        await this.loadPosts(true);
      }
    }).mount("#app");
  </script>
</body>
</html>
