<?php
require_once dirname(__DIR__) . "/lib/db.php";

session_start();

// 로그인 체크
if (!isset($_SESSION["user"])) {
  echo "로그인 후 이용 가능합니다.";
  exit;
}

$pdo = db();

// --------------------------------------------------
// 세션에서 로그인 사용자 정보 가져오기
// --------------------------------------------------
$userId = (int) $_SESSION["user"]["id"];

// --------------------------------------------------
// POST 데이터 수신
// --------------------------------------------------
$title = $_POST["title"] ?? "";
$content = $_POST["content"] ?? "";

// --------------------------------------------------
// 필수값 검증
// --------------------------------------------------
if ($title === "" || $content === "") {
  echo "제목과 내용을 입력하세요.";
  exit;
}

// --------------------------------------------------
// SQL 준비 (INSERT + FK)
// --------------------------------------------------
$sql = "
  INSERT INTO posts (user_id, title, content)
  VALUES (:user_id, :title, :content)
";

$stmt = $pdo->prepare($sql);

// --------------------------------------------------
// 바인딩
// --------------------------------------------------
$stmt->bindValue(":user_id", $userId, PDO::PARAM_INT);
$stmt->bindValue(":title", $title, PDO::PARAM_STR);
$stmt->bindValue(":content", $content, PDO::PARAM_STR);

// --------------------------------------------------
// SQL 실행
// --------------------------------------------------
$stmt->execute();

// --------------------------------------------------
// 방금 작성한 게시글 ID 가져오기
// --------------------------------------------------
$postId = $pdo->lastInsertId();

// --------------------------------------------------
// 게시글 목록 페이지로 이동
// --------------------------------------------------
header("Location: /");
exit;
