<?php
require_once dirname(__DIR__) . "/lib/db.php";

session_start();

$pdo = db();

// --------------------------------------------------
// POST 데이터 수신
// --------------------------------------------------
$username = $_POST["username"] ?? "";
$password = $_POST["password"] ?? "";

// --------------------------------------------------
// 필수값 검증
// --------------------------------------------------
if ($username === "" || $password === "") {
  echo "아이디/비밀번호를 입력하세요.";
  exit;
}

// --------------------------------------------------
// SQL 준비 (SELECT + WHERE)
// --------------------------------------------------
$sql = "
  SELECT
    id,
    username,
    nickname,
    password
  FROM users
  WHERE username = :username
  LIMIT 1
";

$stmt = $pdo->prepare($sql);
$stmt->bindValue(":username", $username, PDO::PARAM_STR);
$stmt->execute();

// --------------------------------------------------
// 결과 1건 조회
// fetch() → 한 행만 가져옴
// --------------------------------------------------
$user = $stmt->fetch();

if (!$user) {
  echo "아이디가 존재하지 않습니다.";
  exit;
}

// --------------------------------------------------
// 비밀번호 검증
// DB에는 해시값이 저장되어 있으므로
// password_verify(입력값, DB해시) 로 비교
// --------------------------------------------------
if (!password_verify($password, $user["password"])) {
  echo "비밀번호가 올바르지 않습니다.";
  exit;
}

// --------------------------------------------------
// 로그인 성공 → 세션 저장
// 비밀번호 해시는 세션에 저장하지 않는다
// --------------------------------------------------
$_SESSION["user"] = [
  "id" => (int) $user["id"],
  "username" => $user["username"],
  "nickname" => $user["nickname"]
];

// --------------------------------------------------
// 로그인 후 메인페이지로 이동
// --------------------------------------------------
header("Location: /");
exit;
