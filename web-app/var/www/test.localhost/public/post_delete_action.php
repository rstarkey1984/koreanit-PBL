<?php
// --------------------------------------------------
// DB 연결 함수 포함
// lib/db.php 안에는 db() 함수(PDO 반환)가 정의되어 있음
// --------------------------------------------------
require_once dirname(__DIR__) . "/lib/db.php";

// --------------------------------------------------
// 세션 시작
// 로그인 여부 및 로그인 사용자 정보 사용을 위해 필요
// --------------------------------------------------
session_start();

// --------------------------------------------------
// 로그인 체크
// 삭제는 로그인한 사용자만 가능
// --------------------------------------------------
if (!isset($_SESSION["user"])) {
  echo "로그인 후 이용 가능합니다.";
  exit;
}

// --------------------------------------------------
// DB 연결 (PDO 객체 생성)
// --------------------------------------------------
$pdo = db();

// --------------------------------------------------
// POST 데이터 수신
// 삭제 대상 게시글 ID
// --------------------------------------------------
$id = $_POST["id"] ?? null;

// --------------------------------------------------
// 입력값 검증
// - id가 없거나
// - 숫자가 아니면 잘못된 접근
// --------------------------------------------------
if ($id === null || !ctype_digit((string) $id)) {
  echo "잘못된 접근입니다.";
  exit;
}

// --------------------------------------------------
// 타입 캐스팅
// --------------------------------------------------
$postId = (int) $id;                          // 삭제할 게시글 ID
$loginUserId = (int) $_SESSION["user"]["id"]; // 로그인한 사용자 ID

// --------------------------------------------------
// DELETE SQL
// - 게시글 ID(id)
// - 작성자 ID(user_id)
// 둘 다 만족하는 경우에만 삭제됨
// → DB 차원에서 권한 체크까지 함께 수행
// --------------------------------------------------
$sql = "
  DELETE FROM posts
  WHERE id = :id
  AND user_id = :user_id
";

// --------------------------------------------------
// SQL 준비 (아직 실행되지 않음)
// --------------------------------------------------
$stmt = $pdo->prepare($sql);

// --------------------------------------------------
// 값 바인딩
// - id, user_id 는 정수이므로 PDO::PARAM_INT 사용
// --------------------------------------------------
$stmt->bindValue(":id", $postId, PDO::PARAM_INT);
$stmt->bindValue(":user_id", $loginUserId, PDO::PARAM_INT);

// --------------------------------------------------
// SQL 실행
// 이 시점에 실제 DELETE가 수행됨
// --------------------------------------------------
$stmt->execute();

// --------------------------------------------------
// 삭제된 행 수 확인
// rowCount() === 0 인 경우
// - 게시글이 존재하지 않거나
// - 본인 글이 아닌 경우
// --------------------------------------------------
if ($stmt->rowCount() === 0) {
  echo "삭제할 수 없습니다. (존재하지 않거나 권한 없음)";
  exit;
}

// --------------------------------------------------
// 삭제 완료 후 메인페이지(목록)로 이동
// --------------------------------------------------
header("Location: /");
exit;
