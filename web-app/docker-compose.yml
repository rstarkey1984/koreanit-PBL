# Docker Compose 프로젝트 이름
name: web-app

services:
  # ----------------------------
  # Nginx (웹 서버 / 리버스 프록시)
  # ----------------------------
  nginx:
    image: nginx:1.27-alpine # 경량 Alpine 기반 Nginx 이미지
    container_name: web-nginx # 컨테이너 이름 고정
    restart: unless-stopped # 수동 중지 전까지 자동 재시작
    ports:
      - "80:80" # 호스트 80 → 컨테이너 80 포트 매핑
    volumes:
      - ./var/www:/var/www:ro # 웹 루트(정적/프론트 리소스), 읽기 전용
      - ./nginx:/etc/nginx/conf.d:ro # Nginx 가상호스트 설정, 읽기 전용
    depends_on:
      - php # php-fpm 컨테이너 먼저 실행
      - api # api 컨테이너 먼저 실행
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # 컨테이너에서 host.docker.internal → 도커 호스트 IP로 접근 가능

  # ----------------------------
  # PHP-FPM (PHP 실행 전용)
  # ----------------------------
  php:
    image: custom-php-fpm:8.3-alpine # 커스텀 PHP-FPM 이미지
    container_name: web-php
    restart: unless-stopped
    volumes:
      - ./var/www/test.localhost:/var/www/test.localhost:ro
      # PHP 소스 코드 마운트 (읽기 전용)
    env_file:
      - .env # DB 정보 등 환경변수 로딩
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # PHP에서 호스트(MySQL, 로컬 API 등) 접근용

  # ----------------------------
  # API 서버 (Spring Boot 등)
  # ----------------------------
  api:
    image: web-app-api:1.0 # API 서버 이미지
    container_name: web-api
    restart: unless-stopped
    expose:
      - "9092" # 컨테이너 내부 통신용 포트
      # 외부 직접 접근 불가, nginx/php 에서만 접근
    env_file:
      - .env # DB, Redis 등 설정 공유
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # API에서 호스트 자원 접근 가능

  # ----------------------------
  # Redis (캐시 / 세션 저장소)
  # ----------------------------
  redis:
    image: redis:7-alpine # Redis 7 Alpine 이미지
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379" # 호스트에서 직접 Redis 접속 가능
    command:
      ["redis-server", "--appendonly", "yes"]
      # AOF(Append Only File) 활성화 → 데이터 영속성 보장
    volumes:
      - redis-data:/data # Redis 데이터 영구 저장

# ----------------------------
# Named Volume 정의
# ----------------------------
volumes:
  redis-data:
    # docker volume 으로 관리되는 Redis 데이터 저장소
